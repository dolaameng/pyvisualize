<!DOCTYPE html>
<html>
<head>
	<title>Demo of Typical Charts Supported by dc.js</title>

	<link rel="stylesheet" type="text/css" href="http://dc-js.github.io/dc.js/css/dc.css">
	<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

</head>
<body>
	
	<h1>Demo of Typical Charts Supported by dc.js - with minimum settings, on <a href="https://github.com/jeroenooms/lausd-data/tree/gh-pages/snack">snack data</a> </h1>

	<!-- Plotting Area -->
	<!--1. one-D categorical bar (location) - never use a Bar!
		2. one-D categorical (or binned numerical) horizontal bar - for large value set (neighborhood)
		3. one-D categorical vs time - stacked bar  (withwho vs date)
		4. contigency table of categorical vs categorical - heatmap (location vs period occurances)
		5. pivot table of aggreagated_numerical on (categorical vs categorical) - heatmap
		6. one-D numerical vs time (avg. healthlevel vs date)
		7. two-D numerical scatter plot (latitude vs longitude - i know it is stupid) 
		8. two-D numerical scatter plot (hour vs healthlevel - again stupid but just for plotting purpose)
		9. categorical vs two numerical : bubble chart - bubble(categorical), radius (group size), x (statics on a numerical), y (statistics on a numerical) - cost vs (latitude, longitude)
		10. one categorical variable vs one numerical variable boxplot (healthlevel v.s. withwho) -->

	<div id="location-bar"><h3>Distribution of Categorical Variable</h3></div>
	<div id="neighorhood-row"><h3>Row Chart for disbutrion of many-value categorical</h3></div>
	<div id="withwho-area-daily"><h3>Distribution of Categorical along Time</h3></div>
	<div id="location-period-hm"><h3>Cooccurance table of two categorical variables</h3></div>
	<div id="avghealth-location-period-hm"><h3>Another heatmap-Pivot Table of avg healthlevel</h3></div>
	<div id="healthlevel-daily"><h3>Numerical variable along time</h3></div>
	<div id="lat-lon-scatter"><h3>Scatter of two numerical variables - lat,lon</h3></div>
	<div id="health-hour-scatter"><h3>Scatter of two numerical variables - healthlevel,hour</h3></div>
	<div id="cost-lat-lon-bubble"><h3>Bubble of two numerical variables grouped by a categorical variable</h3></div>
	<div id="healthlevel-withwho-box"><h3>Boxplot of Categorical v.s. Numerical</h3></div>

	<script type="text/javascript" src="http://dc-js.github.io/dc.js/js/d3.js"></script>
	<script type="text/javascript" src="http://dc-js.github.io/dc.js/js/crossfilter.js"></script>
	<script type="text/javascript" src="http://dc-js.github.io/dc.js/js/dc.js"></script>

	<script type="text/javascript">
	d3.json("modified_snacks.json", function (err, data) {

		var ndx = crossfilter(data);

		// currently supported aggregation functions
		var aggfuns = {
			"average": {
				// reduce add
				"add": function (feature) {
					return function (p, v) {
						p.result = (p.result*p.count + v[feature]) / (p.count + 1);
						p.count += 1;
						return p;
					};
				}
				// reduce remove
				, "remove": function (feature) {
					return function (p, v) {
						if (p.count === 1) {
							p = {result: 0.0, count: 0};
						} else {
							p.result = (p.result*p.count - v[feature]) / (p.count - 1);
							p.count -= 1;}
						return p;
					};
				}
				// reduce init
				, "init": function (feature) {return function () {return {result: 0.0, count: 0};} }
			}
			, "sum": {
				// reduce add
				"add": function (feature) {
					return function (p, v) {
						p.result +=  v[feature];
						return p;
					};
				}
				// reduce remove
				, "remove": function (feature) {
					return function (p, v) {
						p.result -=  v[feature];
						return p;
					};
				}
				// reduce init
				, "init": function (feature) {return function () {return {result: 0.0};} }
			}
			, "count": {
				// reduce add
				"add": function (feature) {
					return function (p, v) {
						p.result +=  1;
						return p;
					};
				}
				// reduce remove
				, "remove": function (feature) {
					return function (p, v) {
						p.result -=  1;
						return p;
					};
				}
				// reduce init
				, "init": function (feature) {return function () {return {result: 0};} }
			}
		};

		var charts = {},
			dims = {},
			groups = {},
			options = {};

		// chart 1 - bar chart
		options["#location-bar"] = {
			anchor: "#location-bar"
			, feature: "location"
			, width: 600
			, height: 300
			, xAxisLabel: "Location"
			, yAxisLabel: 'Frequency'
		};
		charts["#location-bar"] = dc.barChart(options["#location-bar"].anchor);
		dims["#location-bar"] = ndx.dimension(function (d) {return d[options["#location-bar"].feature];});
		groups["#location-bar"] = dims["#location-bar"].group();

		charts["#location-bar"]
			.width(options["#location-bar"].width).height(options["#location-bar"].height)
			.dimension(dims["#location-bar"])
			.group(groups["#location-bar"])
			.x(d3.scale.ordinal())
			.xUnits(dc.units.ordinal)
			.xAxisLabel(options["#location-bar"].xAxisLabel)
			.yAxisLabel(options["#location-bar"].yAxisLabel)
			;

		// chart 2 - row chart
		options["#neighorhood-row"] = {
			anchor: "#neighorhood-row"
			, feature: "neighborhood"
			, width: 800
			, height: 800
			// doesnt support xAxisLabel and yAxisLabel
		};
		charts["#neighorhood-row"] = dc.rowChart(options["#neighorhood-row"].anchor);
		dims["#neighorhood-row"] = ndx.dimension(function (d) {return d[options["#neighorhood-row"].feature];});
		groups["#neighorhood-row"] = dims["#neighorhood-row"].group();

		charts["#neighorhood-row"]
			.width(options["#neighorhood-row"].width).height(options["#neighorhood-row"].height)
			.dimension(dims["#neighorhood-row"])
			.group(groups["#neighorhood-row"])
			.elasticX(true)
			;

		// chart 3 - time series area chart
		options["#withwho-area-daily"] = {
			anchor: "#withwho-area-daily"
			, timefeature: "date"
			, feature: "withwho"
			//, feature_values: ["Alone", "Family", "Friends", "Classmates", "Other", "Co-workers"]
			, width: 800
			, height: 300
			, margins: {top: 10, right: 50, bottom: 30, left: 100}
			, xAxisLabel: "Daily"
			, yAxisLabel: "With Who Dist."
		};
		charts["#withwho-area-daily"] = dc.lineChart(options["#withwho-area-daily"].anchor);
		dims["#withwho-area-daily"] = ndx.dimension(function (d) {
			return new Date(d[options["#withwho-area-daily"].timefeature]); 
		});
		groups["#withwho-area-daily"] = dims["#withwho-area-daily"].group().reduce(
			// reduce add
			function (p, v) {
				var f = options["#withwho-area-daily"].feature; 
				p[v[f]] = (p[v[f]] || 0) + 1;
				return p;
			}
			// reduce remove
			, function (p, v) {
				var f = options["#withwho-area-daily"].feature; 
				p[v[f]] = (p[v[f]] || 0) - 1;
				return p;
			}
			// reduce init
			, function () {
				return {};
			}
		);
		var minDate = new Date(dims["#withwho-area-daily"].bottom(1)[0][options["#withwho-area-daily"].timefeature]);
		var maxDate = new Date(dims["#withwho-area-daily"].top(1)[0][options["#withwho-area-daily"].timefeature]);
		var feature_values = [];
		ndx.dimension(function (d) {return d[options["#withwho-area-daily"].feature];})
								.group().top(Infinity).forEach(function(kv){feature_values.push(kv.key);});
		var select_stack = function (i) {return function(kv) {return (kv.value[i] || 0); } };
		charts["#withwho-area-daily"]
			.width(options["#withwho-area-daily"].width).height(options["#withwho-area-daily"].height)
			.dimension(dims["#withwho-area-daily"])
			.group(groups["#withwho-area-daily"], feature_values[0], select_stack(feature_values[0]))
			.margins(options["#withwho-area-daily"].margins)
			.x(d3.time.scale().domain([minDate, maxDate]))
			.renderArea(true)
			.elasticY(true)
			.xAxisLabel(options["#withwho-area-daily"].xAxisLabel)
			.yAxisLabel(options["#withwho-area-daily"].yAxisLabel)
			.legend(dc.legend())
			;
		for (var i = 1; i < feature_values.length; ++i) {
			charts["#withwho-area-daily"].stack(groups["#withwho-area-daily"], feature_values[i], 
				feature_values[i]);
		}

		// chart 4 - location period heatmap
		var minmax_value = function (group) {
			// assume group is ordered by value
			var xs = group.order(function (p) {return p.result;}).top(Infinity);
			return [xs[xs.length - 1].value.result, xs[0].value.result];
		};
		options["#location-period-hm"] = {
			anchor: "#location-period-hm"
			, colum_feature: "location"
			, index_feature: "period"
			, value_feature: null
			, tooltip_prefix: "frequency:"
			, aggfun: "count"
			, width: 500
			, height: 300
			, margins: {top: 10, right: 50, bottom: 30, left: 100}
			, colorRange: ["#95ff95", "green"]
		};
		charts["#location-period-hm"] = dc.heatMap(options["#location-period-hm"].anchor);
		dims["#location-period-hm"] = ndx.dimension(function (d) {
			return [d[options["#location-period-hm"].colum_feature], 
					d[options["#location-period-hm"].index_feature]];
		});
		groups["#location-period-hm"] = dims["#location-period-hm"].group().reduce(
			// reduce add
			aggfuns[options["#location-period-hm"].aggfun].add(options["#location-period-hm"].value_feature)
			// reduce remove
			, aggfuns[options["#location-period-hm"].aggfun].remove(options["#location-period-hm"].value_feature)
			// reduce init
			, aggfuns[options["#location-period-hm"].aggfun].init(options["#location-period-hm"].value_feature)
		);

		charts["#location-period-hm"]
			.width(options["#location-period-hm"].width)
			.height(options["#location-period-hm"].height)
			.margins(options["#location-period-hm"].margins)
			.dimension(dims["#location-period-hm"])
			.group(groups["#location-period-hm"])
			.keyAccessor(function (kv) {return kv.key[0];})
			.valueAccessor(function (kv) {return kv.key[1];})
			.colorAccessor(function (kv) {return kv.value.result;})
			.renderLabel(true)
			.colors(d3.scale.linear().domain(minmax_value(groups["#location-period-hm"])).range(options["#location-period-hm"].colorRange))
			.title(function(kv) {return options["#location-period-hm"].tooltip_prefix+kv.value.result;})  //tooltip
			;

		// chart 5 - avghealth-location-period-hm
		var minmax_value = function (group) {
			// assume group is ordered by value
			var xs = group.order(function (p) {return p.result;}).top(Infinity);
			return [xs[xs.length - 1].value.result, xs[0].value.result];
		};
		options["#avghealth-location-period-hm"] = {
			anchor: "#avghealth-location-period-hm"
			, colum_feature: "location"
			, index_feature: "period"
			, value_feature: "healthlevel"
			, tooltip_prefix: "avg health:"
			, aggfun: "average"
			, width: 500
			, height: 300
			, margins: {top: 10, right: 50, bottom: 30, left: 100}
			, colorRange: ["#9595ff", "#0000ff"]
		};
		charts["#avghealth-location-period-hm"] = dc.heatMap(options["#avghealth-location-period-hm"].anchor);
		dims["#avghealth-location-period-hm"] = ndx.dimension(function (d) {
			return [d[options["#avghealth-location-period-hm"].colum_feature], 
					d[options["#avghealth-location-period-hm"].index_feature]];
		});
		groups["#avghealth-location-period-hm"] = dims["#avghealth-location-period-hm"].group().reduce(
			// reduce add
			aggfuns[options["#avghealth-location-period-hm"].aggfun].add(options["#avghealth-location-period-hm"].value_feature)
			// reduce remove
			, aggfuns[options["#avghealth-location-period-hm"].aggfun].remove(options["#avghealth-location-period-hm"].value_feature)
			// reduce init
			, aggfuns[options["#avghealth-location-period-hm"].aggfun].init(options["#avghealth-location-period-hm"].value_feature)
		);

		charts["#avghealth-location-period-hm"]
			.width(options["#avghealth-location-period-hm"].width)
			.height(options["#avghealth-location-period-hm"].height)
			.margins(options["#avghealth-location-period-hm"].margins)
			.dimension(dims["#avghealth-location-period-hm"])
			.group(groups["#avghealth-location-period-hm"])
			.keyAccessor(function (kv) {return kv.key[0];})
			.valueAccessor(function (kv) {return kv.key[1];})
			.colorAccessor(function (kv) {return kv.value.result;})
			.renderLabel(true)
			.colors(d3.scale.linear().domain(minmax_value(groups["#avghealth-location-period-hm"])).range(options["#avghealth-location-period-hm"].colorRange))
			.title(function(kv) {return options["#avghealth-location-period-hm"].tooltip_prefix+kv.value.result;})  //tooltip
			;


		// chart 6 - health level time series 
		options["#healthlevel-daily"] = {
			anchor: "#healthlevel-daily"
			, timefeature: "date"
			, feature: "healthlevel"
			, aggfun: "average" // supported by the aggfuns defined at the top
			, width: 600
			, height: 400
			, xAxisLabel: "Daily"
			, yAxisLabel: "Avg healthlevel daily"
		};
		charts["#healthlevel-daily"] = dc.lineChart(options["#healthlevel-daily"].anchor);
		dims["#healthlevel-daily"] = ndx.dimension(function (d) {
			return new Date(d[options["#healthlevel-daily"].timefeature]); 
		});
		var minDate = new Date(dims["#healthlevel-daily"].bottom(1)[0][options["#healthlevel-daily"].timefeature]);
		var maxDate = new Date(dims["#healthlevel-daily"].top(1)[0][options["#healthlevel-daily"].timefeature]);
		groups["#healthlevel-daily"] = dims["#healthlevel-daily"].group().reduce(
			// reduce add
			aggfuns[options["#healthlevel-daily"].aggfun].add(options["#healthlevel-daily"].feature)
			// reduce remove
			, aggfuns[options["#healthlevel-daily"].aggfun].remove(options["#healthlevel-daily"].feature)
			// reduce init
			, aggfuns[options["#healthlevel-daily"].aggfun].init(options["#healthlevel-daily"].feature)
		);
		charts["#healthlevel-daily"]
			.width(options["#healthlevel-daily"].width).height(options["#healthlevel-daily"].height)
			.dimension(dims["#healthlevel-daily"])
			.group(groups["#healthlevel-daily"])
			.valueAccessor(function (kv) {return kv.value.result || 0;})
			.x(d3.time.scale().domain([minDate, maxDate]))
			.elasticY(true)
			.xAxisLabel(options["#healthlevel-daily"].xAxisLabel)
			.yAxisLabel(options["#healthlevel-daily"].yAxisLabel)
			;

		// chart 7 - lat-lon-scatter
		options

		// chart 8 - health-hour-scatter

		// chart 9 - cost-lat-lon-bubble

		// chart 10 - healthlevel-withwho-box

		
		dc.renderAll();
	});
	</script>
</body>
</html>